<html>
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"/>
	<link type="text/css" rel="stylesheet" href="stylesheet.css"/>
	<head>
		<title>Pizza Goblin</title>
		<script type="text/javascript" src="http://platform.linkedin.com/in.js">
			api_key: 7515r9sepuulis
			authorize: true
		</script>
        <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization',
       'version':'1','packages':['timeline', 'corechart']}]}"></script>
	</head>
	<body onLoad="onLinkedInLoad()">
		<script type="text/javascript">
        var SECONDS_IN_A_YEAR = 31536000;
        function onLinkedInLoad() {
			  IN.Event.on(IN, "auth", function() {onLinkedInLogin();});
			  IN.Event.on(IN, "logout", function() {onLinkedInLogout();});
			}

        function onLinkedInLogout() {
          getThingsDone(false);
        }

        function onLinkedInLogin() {
          // we pass field selectors as a single parameter (array of strings)
          IN.API.Profile("me")
            .fields(["location", "formattedName", "pictureUrl", "positions",
                      "industry", "headline", "summary", "educations", "interests"])
            .result(function(result) {
              getThingsDone(result.values[0]);
            })
            .error(function(err) {
              alert(err);
            });
        }

        function getJobInfo(profile) {
            var jobs = new Array();

            for (var i in profile.positions.values) {
                var job = new Object()

                job.title = profile.positions.values[i].title.toString();
                job.company = profile.positions.values[i].company;

                var startMonth = profile.positions.values[i].startDate.month;
                var startYear = profile.positions.values[i].startDate.year;
                job.startDate = new Date(startYear, startMonth, 1);

                var endMonth = undefined;
                var endYear = undefined;
                d = new Date();
                if(profile.positions.values[i].isCurrent){
                    endMonth = d.getMonth();
                    endYear = d.getFullYear();
                } else {
                    endMonth = profile.positions.values[i].endDate.month;
                    endYear = profile.positions.values[i].endDate.year;
                }

                job.endDate = new Date(endYear, endMonth, 1);
                job.duration = (((job.endDate - job.startDate) / 1000) / SECONDS_IN_A_YEAR).toFixed(2);

                jobs.push(job);
            }
            return jobs;
        }

        function makeProfileHTML(profile){
            var HTML = "";
            var defaultImage = "https://static.licdn.com/scds/common/u/images/themes/katy/ghosts/person/ghost_person_200x200_v1.png";
            var name = profile.formattedName;
            var headline = profile.headline || "";
            var photo = profile.pictureUrl || defaultImage;
            var position = profile.positions.values[0].title + " at " + profile.positions.values[0].company.name;

            HTML += "<img src=\"" + photo + "\" height=\"100\" width=\"100\" id=\"profilePhoto\"/>";
            HTML += "<p id=\"info\">" + name + ", " + position + "</p>";
            if( position != headline){
                HTML += "<p>" + headline + "</p>";
            }

            return HTML;
        }

        function createTimelineData(jobList, profile){
            var results = new Array();

            if (profile.educations) {
                for (var i in profile.educations.values) {
                    var school = new Array();
                    school.push("School");
                    school.push(profile.educations.values[i].schoolName);

                    /* In a better, more verdant world, LinkedIn would ask for at least a month alongside
                       a year value so that this graph could be more accurate, but alas, it is not. */
                    // note that months are zero-based in the JavaScript Date object, so month 3 is April
                    var startDate = new Date(profile.educations.values[i].startDate.year, 0, 1) || new Date(0, 0, 0)
                    var endDate = new Date(profile.educations.values[i].endDate.year, 11, 30) || new Date(0, 0, 0)
                    school.push(startDate);
                    school.push(endDate);
                    results.push(school);
                }
            }
            for (var i in jobList){
                var job = new Array();
                job.push("Work");
                job.push(jobList[i].company.name);
                job.push(jobList[i].startDate);
                job.push(jobList[i].endDate);
                results.push(job);
            }
            return results;
        }

        function drawTimeline(rows) {
            var container = document.getElementById('schoolWorkChart');
            var chart = new google.visualization.Timeline(container);
            var dataTable = new google.visualization.DataTable();
            var columns = [{type: 'string', id: 'Activity'}, {type: 'string', id: 'Name'},
                           {type: 'date', id: 'Start'}, {type: 'date', id: 'End'}];
            var options = { enableInteractivity: false };
            for (var i in columns){ dataTable.addColumn(columns[i]); }

            dataTable.addRows(rows);
            chart.draw(dataTable, options);
        }

        function createDonutData(jobList){
            var results = new Array();
            results.push(["Title", "Duration"]);
            for (var i in jobList){
                var job = new Array();
                job.push(jobList[i].title);
                job.push(parseFloat(jobList[i].duration));
                results.push(job);
            }
            return results;
        }

        function drawPieChart(sourceData) {
            var data = google.visualization.arrayToDataTable(sourceData);
            var options = { title: 'My Career',
                            chartArea: { width: '100%',
                                         height:'100%'},
                            legend: {alignment: 'center'},
                            is3D: true };

            var chart = new google.visualization.PieChart(document.getElementById('donutChart'));
            chart.draw(data, options);
        }

        function getWordCount(summary){
            // Credit to Mike Grace: http://stackoverflow.com/a/4328722/1667207
            summary = summary.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,""); // eliminate punctuation
            summary = summary.replace(/\s{2,}/g," ");                       // eliminate multiple spaces
            summary = summary.replace(/[^\x00-\x7F]+/g, "");                // replaces non-ASCII characters.
            summary = summary.toLowerCase().split(" ");

            var exceptedWords = ["the", "to", "of", "and", "a", "an",
                                 "in", "it", "its", "for", "on", "this",
                                 "is", "with", "as", "at", "by", "or"];
            var results = [['Word', 'Count']];
            var words = new Object();

            //Inspired by Å ime Vidas: http://stackoverflow.com/a/5668246/1667207
            for (var i = 0; i < summary.length; i++) {
                if (isNaN(summary[i])) {
                    if (summary[i] in words) {
                        words[summary[i]]++;
                    } else {
                        words[summary[i]] = 1;
                    }
                }
            }

            for (var key in words){
                if (exceptedWords.indexOf(key) == -1) {
                    if (words[key] > 1) {
                        var hit = new Array();
                        if (key === "i") {
                            hit[0] = "I";
                            hit[1] = words[key];
                        } else {
                            hit[0] = key;
                            hit[1] = words[key];
                        }
                        results.push(hit);
                    } else {}
                }
            }

            if (results.length == 1){
                return undefined;
            } else {
                return results;
            }
        }

        function drawWordChart(wordCount) {
            var data = google.visualization.arrayToDataTable(wordCount);

            var options = { title: 'Words in LinkedIn summary that appear more than once',
                            hAxis: { titleTextStyle: {color: 'blue'}}};

            var chart = new google.visualization.ColumnChart(document.getElementById('wordCountChart'));

            chart.draw(data, options);
        }

        function getThingsDone(profile) {
            if (!profile) {
                document.getElementById("background").innerHTML = "<p>You must log in!</p>";
            } else {
                var jobList = getJobInfo(profile);
                document.getElementById("profileInfo").innerHTML = makeProfileHTML(profile);
                var pieData = createDonutData(jobList);
                drawPieChart(pieData);
                var timeLine = createTimelineData(jobList, profile);
                drawTimeline(timeLine);
                if(profile.summary){
                    var wordCount = getWordCount(profile.summary);
                    if (wordCount){
                        drawWordChart(wordCount);
                    }
                }
            }
        }
        </script>
        <div id="background">
            <div id="linkedLogIn"><script type="IN/Login"></script></div>
            <div id="profileInfo" class="profile"></div>
            <div id="donutChart" style="position: relative; width: 60%; margin-top: 4em;"></div>
            <div id="schoolWorkChart" style="position: relative; margin-bottom: -70px;"></div>
            <div id="wordCountChart"></div>
        </div>
	</body>
</html>
