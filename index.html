<html>
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"/>
	<link type="text/css" rel="stylesheet" href="stylesheet.css"/>
	<head>
		<title>Pizza Goblin</title>
		<script type="text/javascript" src="http://platform.linkedin.com/in.js">
			api_key: 7515r9sepuulis
			authorize: true
		</script>
        <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization',
       'version':'1','packages':['timeline', 'corechart']}]}"></script>
	</head>
	<body onLoad="onLinkedInLoad()">
		<script type="text/javascript">
        function onLinkedInLoad() {
			  IN.Event.on(IN, "auth", function() {onLinkedInLogin();});
			  IN.Event.on(IN, "logout", function() {onLinkedInLogout();});
			}

        function onLinkedInLogout() {
          getThingsDone(false);
        }

        function onLinkedInLogin() {
          // we pass field selectors as a single parameter (array of strings)
          IN.API.Profile("me")
            .fields(["location", "formattedName", "pictureUrl", "positions", "specialties", "connections", "numRecommenders",
                      "industry", "headline", "summary", "skills", "numConnections", "jobBookmarks", "languages",
                      "suggestions", "courses", "educations", "volunteer", "patents", "interests", "associations"])
            .result(function(result) {
              getThingsDone(result.values[0]);
            })
            .error(function(err) {
              alert(err);
            });
        }

        function getJobInfo(profile) {

            var jobs = new Array();

            for (var i in profile.positions.values) {

                var job = new Object()

                job.title = profile.positions.values[i].title.toString();
                job.company = profile.positions.values[i].company;
                job.summary = profile.positions.values[i].summary;

                var startMonth = profile.positions.values[i].startDate.month;
                var startYear = profile.positions.values[i].startDate.year;
                job.startDate = new Date(startYear, startMonth, 1);
                var endMonth = undefined;
                var endYear = undefined;
                d = new Date();

                if(profile.positions.values[i].isCurrent){
                    endMonth = d.getMonth();
                    endYear = d.getFullYear();
                } else {
                    endMonth = profile.positions.values[i].endDate.month;
                    endYear = profile.positions.values[i].endDate.year;
                }

                job.endDate = new Date(endYear, endMonth, 1);
                var SECONDS_IN_A_YEAR = 31536000;
                job.duration = (((job.endDate - job.startDate) / 1000) / SECONDS_IN_A_YEAR).toFixed(2);

                jobs.push(job);
            }
            return jobs;
        }

        function createTimelineData(jobList, profile){
            var results = new Array();

            if (profile.educations) {
                for (var i in profile.educations.values) {
                    var school = new Array();
                    school.push("School");
                    school.push(profile.educations.values[i].schoolName);

                    /* In a better, more verdent world, LinkedIn would ask for at least a month alongside
                       a year value so that this graph could be more accurate, but alas, it is not. */
                    school.push(new Date(profile.educations.values[i].startDate.year, 0, 1));
                    school.push(new Date(profile.educations.values[i].endDate.year, 11, 30));
                    // note that months are zero-based in the JavaScript Date object, so month 3 is April
                    results.push(school);
                }
            }
            for (var i in jobList){
                var job = new Array();
                job.push("Work");
                job.push(jobList[i].company.name);
                job.push(jobList[i].startDate);
                job.push(jobList[i].endDate);
                results.push(job);
            }
            return results;
        }

        function drawTimeline(rows) {
            var container = document.getElementById('schoolWorkChart');
            var chart = new google.visualization.Timeline(container);
            var dataTable = new google.visualization.DataTable();
            var columns = [{type: 'string', id: 'Activity'}, {type: 'string', id: 'Name'},
                {type: 'date', id: 'Start'}, {type: 'date', id: 'End'}];

            var options = { "height": 175 };

            for (var i in columns){ dataTable.addColumn(columns[i]); }
            dataTable.addRows(rows);
            chart.draw(dataTable, options);
        }

        function createDonutData(jobList){
            var results = new Array();
            results.push(["Title", "Duration"]);
            for (var i in jobList){
                var job = new Array();
                job.push(jobList[i].title);
                job.push(parseFloat(jobList[i].duration));
                results.push(job);
            }
            return results;
        }

        function drawDonutChart(sourceData) {

            var data = google.visualization.arrayToDataTable(sourceData);

            var options = { title: 'My Career',
                pieHole: 0.5, // what a variable name!
                chartArea: { width:'90%',
                    height:'90%'},
                pieSliceText: 'none',
                legend: {alignment: 'center'} };

            var chart = new google.visualization.PieChart(document.getElementById('donutChart'));
            chart.draw(data, options);
        }

        function getWordCount(source){
            //credit to Å ime Vidas: http://stackoverflow.com/a/5668246/1667207
            source = source.toLowerCase().split(" ");
            var words = new Array();
            var count = new Array();
            var exceptedWords = ["the", "to", "of", "and", "a",
                                 "in", "it", "its", "for", "on",
                                 "with", "as", "at", "by", "or", "an"];
            var prev = undefined;
            var result = [['Word', 'Count']];
            source.sort();

            for (var i = 0; i < source.length; i++) {
                if (source[i] !== prev) {
                    var exception = exceptedWords.indexOf(source[i]);
                    if (exception > -1) {
                    } else {
                        words.push(source[i]);
                        count.push(1);
                    }
                } else {
                    count[count.length - 1]++;
                }
                prev = source[i];
            }
                for (var i in words) {
                    var match = []
                    if( count[i] > 1){
                        if( words[i] === "i" ){
                            match[0] = "I";
                        } else {
                            match[0] = words[i];
                        }
                        match[1] = count[i];
                        result.push(match);
                    } else {}
                }
            return result;
        }

        function drawWordChart(wordCount) {
            var data = google.visualization.arrayToDataTable(wordCount);

            var options = {
                title: 'Summary word frequency',
                hAxis: {title: 'Word', titleTextStyle: {color: 'blue'}}
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('wordCountChart'));

            chart.draw(data, options);
        }

        function getThingsDone(profile) {
            if (!profile) {
                document.getElementById("background").innerHTML = "<p>You must log in!</p>";
            } else {
                var jobList = getJobInfo(profile);
                var donutData = createDonutData(jobList);
                var timeLine = createTimelineData(jobList, profile);
                var wordCount = getWordCount(profile.summary);
                drawTimeline(timeLine);
                drawDonutChart(donutData);
                drawWordChart(wordCount);
            }
        }

        </script>
        <div id="background">
            <div id="linkedLogIn"><script type="IN/Login"></script></div>
            <div id="donutChart"></div>
            <div id="schoolWorkChart"></div>
            <div id="wordCountChart"></div>
        </div>
	</body>
</html>
